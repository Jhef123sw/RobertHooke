{% extends base_template %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Reportes</title>
    <link rel="stylesheet" href="{% static 'css/dashboard_reportes.css' %}">
</head>
<body>
<div class="container">
    <h1>Reportes de Simulacros</h1>

    <div class="nivel-buttons">
        <button class="nivel-btn" data-nivel="90">Pre</button>
        <button class="nivel-btn" data-nivel="30">Semillero</button>
    </div>

    <div id="fechas-container" class="fechas-bar"></div>

    <div class="table-responsive">
        <table class="tabla-resultados">
            <thead>
                <tr>
                    <th>Puesto</th>
                    <th>Usuario</th>
                    <th>Estudiante</th>
                    <th>Buenas</th>
                    <th>Malas</th>
                    <th>Blanco</th>
                    <th>% Buenas</th>
                    <th>% Malas</th>
                    <th>% Blancas</th>
                    <th>Puntaje</th>
                </tr>
            </thead>
            <tbody id="resultados-body">
                <tr>
                    <td colspan="7" style="text-align:center;">Seleccione un nivel y una fecha para ver los resultados</td>
                </tr>
            </tbody>
        </table>
        <div class="exportar-pdf">
            <a id="btn-pdf" href="#" class="btn btn-danger" target="_blank">ðŸ“„ Exportar PDF</a>
        </div>

        <script>
        let nivelSeleccionado = null;
        let fechaSeleccionada = null;

        document.querySelectorAll(".nivel-btn").forEach(btn => {
            btn.addEventListener("click", function(){
                nivelSeleccionado = this.dataset.nivel;
            });
        });

        function seleccionarFecha(fecha) {
            fechaSeleccionada = fecha;
            document.getElementById("btn-pdf").href = `/reportes/exportar_pdf/${nivelSeleccionado}/${fechaSeleccionada}/`;
        }
        </script>

    </div>




    <div id="resultados-container" class="resultados-grid">
        <p>Seleccione un nivel y una fecha para ver los resultados.</p>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
    const fechasContainer = document.getElementById("fechas-container");
    const resultadosContainer = document.getElementById("resultados-container");
    let nivelSeleccionado = null;

    document.querySelectorAll(".nivel-btn").forEach(btn => {
        btn.addEventListener("click", function(){
            nivelSeleccionado = this.dataset.nivel;
            fetch(`/reportes/obtener_fechas_nivel/${nivelSeleccionado}/`)
                .then(res => res.json())
                .then(data => {
                    fechasContainer.innerHTML = "";
                    data.fechas.forEach(fecha => {
                        let fechaBtn = document.createElement("button");
                        fechaBtn.classList.add("fecha-btn");
                        fechaBtn.textContent = fecha;
                        fechaBtn.addEventListener("click", function(){
                            fetch(`/reportes/obtener_resultados_fecha1/${nivelSeleccionado}/${fecha}/`)
                                .then(res => res.json())
                                .then(data => {
                                    const tbody = document.getElementById("resultados-body");
                                    tbody.innerHTML = "";

                                    if (data.resultados.length > 0) {
                                        data.resultados.forEach(r => {
                                            tbody.innerHTML += `
                                                <tr>
                                                    <td style="color: black;">${r.puesto}</td>
                                                    <td style="color: black;">${r.usuario}</td>
                                                    <td style="color: black;">${r.estudiante}</td>
                                                    <td style="color: black;">${r.buenas}</td>
                                                    <td style="color: black;">${r.malas}</td>
                                                    <td style="color: black;">${r.blancas}</td>
                                                    <td style="color: black;">${r.porcentaje_buenas}%</td>
                                                    <td style="color: black;">${r.porcentaje_malas}%</td>
                                                    <td style="color: black;">${r.porcentaje_blancas}%</td>
                                                    <td style="color: black;">${r.puntaje}</td>
                                                </tr>
                                            `;
                                        });
                                    } else {
                                        tbody.innerHTML = `<tr>
                                            <td colspan="7" style="text-align:center;">No hay resultados para esta fecha.</td>
                                        </tr>`;
                                    }
                                });

                        });
                        fechasContainer.appendChild(fechaBtn);
                    });
                });
        });
    });
});
</script>
</body>
</html>
{% endblock %}