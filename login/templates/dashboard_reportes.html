{% extends base_template %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Reportes</title>
    <link rel="stylesheet" href="{% static 'css/dashboard_reportes.css' %}">
</head>
<body>
<div class="container">
    <h1>Reportes de Simulacros</h1>

    <div class="nivel-buttons">
        <button class="nivel-btn" data-nivel="90">Pre</button>
        <button class="nivel-btn" data-nivel="30">Semillero</button>
    </div>

    <div id="fechas-container" class="fechas-bar"></div>

    <div class="table-responsive">
        <table class="tabla-resultados">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Estudiante</th>
                    <th>Puntaje</th>
                    <th>Puesto</th>
                    <th>Materia</th>
                    <th>Buenas</th>
                    <th>Malas</th>
                    <th>En Blanco</th>
                </tr>
            </thead>
            <tbody id="resultados-body">
                <tr>
                    <td colspan="8" style="text-align:center;">Seleccione un nivel y una fecha para ver los resultados</td>
                </tr>
            </tbody>
        </table>
    </div>


    <div id="resultados-container" class="resultados-grid">
        <p>Seleccione un nivel y una fecha para ver los resultados.</p>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
    const fechasContainer = document.getElementById("fechas-container");
    const resultadosContainer = document.getElementById("resultados-container");
    let nivelSeleccionado = null;

    document.querySelectorAll(".nivel-btn").forEach(btn => {
        btn.addEventListener("click", function(){
            nivelSeleccionado = this.dataset.nivel;
            fetch(`/obtener_fechas_nivel/${nivelSeleccionado}/`)
                .then(res => res.json())
                .then(data => {
                    fechasContainer.innerHTML = "";
                    data.fechas.forEach(fecha => {
                        let fechaBtn = document.createElement("button");
                        fechaBtn.classList.add("fecha-btn");
                        fechaBtn.textContent = fecha;
                        fechaBtn.addEventListener("click", function(){
                            fetch(`/obtener_resultados_fecha/${nivelSeleccionado}/${fecha}/`)
                                .then(res => res.json())
                                .then(data => {
                                    const resultadosBody = document.getElementById("resultados-body");
                                    resultadosBody.innerHTML = "";

                                    if (data.resultados.length > 0) {
                                        let contador = 1;
                                        data.resultados.forEach(r => {
                                            for (const materia in r.datos) {
                                                let [buenas, malas] = r.datos[materia];
                                                let enBlanco = 10 - (buenas + malas); // Ajusta si no son 10 preguntas
                                                resultadosBody.innerHTML += `
                                                    <tr>
                                                        <td>${contador}</td>
                                                        <td>${r.estudiante}</td>
                                                        <td>${r.puntaje}</td>
                                                        <td>${r.puesto}</td>
                                                        <td>${materia}</td>
                                                        <td>${buenas}</td>
                                                        <td>${malas}</td>
                                                        <td>${enBlanco}</td>
                                                    </tr>
                                                `;
                                            }
                                            contador++;
                                        });
                                    } else {
                                        resultadosBody.innerHTML = `<tr>
                                            <td colspan="8" style="text-align:center;">No hay resultados para esta fecha.</td>
                                        </tr>`;
                                    }
                                });

                        });
                        fechasContainer.appendChild(fechaBtn);
                    });
                });
        });
    });
});
</script>
</body>
</html>
{% endblock %}
